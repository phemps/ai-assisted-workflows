# syntax=docker/dockerfile:1
# Node.js-focused image for CLI evaluation
FROM node:20-alpine AS node-eval

# Create non-root user with specific UID/GID
RUN addgroup -g 1001 evaluator && \
    adduser -u 1001 -G evaluator -D -s /bin/bash evaluator

# Install essential tools
RUN apk add --no-cache \
    curl wget git bash \
    python3 py3-pip \
    ca-certificates \
    && rm -rf /var/cache/apk/*

# Setup secure directories
RUN mkdir -p /home/evaluator/workspace /home/evaluator/.cache && \
    chown -R evaluator:evaluator /home/evaluator

# Set up environment
ENV PATH="/home/evaluator/.local/bin:$PATH"

# Ensure PATH is available in multiple contexts for login and non-login shells (as root)
RUN echo 'export PATH="/home/evaluator/.local/bin:$PATH"' >> /etc/profile && \
    echo 'export PATH="/home/evaluator/.local/bin:$PATH"' >> /home/evaluator/.bashrc && \
    chown evaluator:evaluator /home/evaluator/.bashrc

USER evaluator
WORKDIR /home/evaluator/workspace

# Configure npm for user installation
RUN npm config set prefix "/home/evaluator/.local"

# Install common Node packages (as user)
RUN npm install -g typescript eslint prettier

# Install Python packages for installers
RUN pip3 install --user --no-cache-dir --break-system-packages \
    pyyaml requests

CMD ["sleep", "infinity"]
