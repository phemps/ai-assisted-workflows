# ==========================================
# DEVELOPMENT WORKFLOW FOR TURBOREPO
# ==========================================
# CRITICAL: Claude should NEVER run 'make dev'
# Always ask user to start development services
# ==========================================

.PHONY: dev tail-log lint test format clean status stop help

# Start all development services (USER ONLY - NEVER AUTOMATED)
dev:
	@echo "ğŸš€ Starting Turborepo development environment..."
	@echo "ğŸ“± Services will start with auto-reload enabled"
	@echo "ğŸ“ Logs will be written to dev.log"
	@rm -f dev.log
	@touch dev.log
	@echo "$$(date): Development services starting" >> dev.log
	shoreman Procfile

# Access unified development logs (Claude can use this)
tail-log:
	@if [ -f dev.log ]; then \
		echo "ğŸ“‹ Development logs (use Ctrl+C to exit):"; \
		tail -f dev.log; \
	else \
		echo "âŒ No development logs found. Run 'make dev' first."; \
	fi

# Show current service status
status:
	@if [ -f shoreman.pid ]; then \
		echo "âœ… Development services are running (PID: $$(cat shoreman.pid))"; \
		echo "ğŸ“ Log file: dev.log"; \
		echo "ğŸ” Use 'make tail-log' to view logs"; \
	else \
		echo "âŒ Development services are not running"; \
		echo "ğŸš€ Run 'make dev' to start services"; \
	fi

# Stop all services (USER ONLY)
stop:
	@if [ -f shoreman.pid ]; then \
		echo "ğŸ›‘ Stopping development services..."; \
		kill $$(cat shoreman.pid) 2>/dev/null || true; \
		rm -f shoreman.pid; \
		echo "âœ… Services stopped"; \
	else \
		echo "â„¹ï¸  No services running"; \
	fi

# Code quality and testing
lint:
	@echo "ğŸ” Running linting across monorepo..."
	npx turbo lint

test:
	@echo "ğŸ§ª Running tests across monorepo..."
	npx turbo test

format:
	@echo "âœ¨ Formatting code across monorepo..."
	npx turbo format

# Cleanup
clean:
	@echo "ğŸ§¹ Cleaning build artifacts..."
	npx turbo clean
	@echo "ğŸ—‘ï¸  Removing log files..."
	rm -f dev.log shoreman.pid
	@echo "âœ… Cleanup complete"

# Help
help:
	@echo "ğŸ“š Turborepo Development Commands:"
	@echo ""
	@echo "  make dev       Start all services (web, mobile, backend)"
	@echo "  make tail-log  View unified development logs"
	@echo "  make status    Check if services are running"
	@echo "  make stop      Stop all development services"
	@echo ""
	@echo "  make lint      Run code quality checks"
	@echo "  make test      Run test suites"
	@echo "  make format    Format all code"
	@echo "  make clean     Clean build artifacts and logs"
	@echo ""
	@echo "âš ï¸  Claude should NEVER run 'make dev' or 'make stop'"
	@echo "ğŸ“‹ Claude can use 'make tail-log' and 'make status'"
